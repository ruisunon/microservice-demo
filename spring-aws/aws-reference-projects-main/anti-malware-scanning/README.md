### Anti-malware scanning on S3 Bucket(s)

This proof of concept provides a simple implementation of an anti-malware scanning solution that can be used to scan files being uploaded into target S3 bucket(s) for any malware or virus. For every [S3:PutObject](https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutObject.html) performed, a Lambda function is triggered using S3 Event Notification that fetches the file and passes it through an instance running ClamAV open-source antivirus engine. If any virus/malware is detected, the event record information is published to an SNS topic and the message is received by all it's subscribers.

#### Services used
* [Amazon S3 Event Notification](https://docs.aws.amazon.com/AmazonS3/latest/userguide/NotificationHowTo.html)
* [AWS Lambda](https://aws.amazon.com/lambda/)
* [ClamAV open-source antivirus engine](https://www.clamav.net)
* [AWS SNS](https://aws.amazon.com/sns/)

#### Architecture diagram

![anti-malware-scanning-s3](https://user-images.githubusercontent.com/69693621/207793461-9d9f0195-58d8-4d99-93c7-8496880662bb.png)

#### Important classes
* [AntiMalwareScannerService.class](https://github.com/hardikSinghBehl/aws-reference-projects/blob/main/anti-malware-scanning/src/main/java/com/behl/malware/detector/AntiMalwareScannerService.java)
* [RemedialProcedure.class](https://github.com/hardikSinghBehl/aws-reference-projects/blob/main/anti-malware-scanning/src/main/java/com/behl/malware/detector/RemedialProcedure.java)
* [RequestExecutor.class](https://github.com/hardikSinghBehl/aws-reference-projects/blob/main/anti-malware-scanning/src/main/java/com/behl/malware/detector/RequestExecutor.java)

#### Demonstration screen recording

https://user-images.githubusercontent.com/69693621/207907240-529dc7e7-e732-477e-9b65-91055f4c33b7.mov

---
#### ClamAV Deployment

ClamAV is an open-source antivirus engine for detecting trojans, viruses, malware & other malicious threats in files. It is recommended to be deployed on a server with 4GB+ RAM, it was run on a `t2.2xlarge` EC2 Instance for this POC. Depending on the workload, several servers in an auto-scaling group can be exposed behind a load balancer to achieve greater scalability. Alternatively ECS and Fargate services can also be used for running ClamAV.

The below user data script was used in an ubuntu based EC2 Instance to run ClamAV on port `3310`

```
#!/bin/bash
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh
systemctl start docker
docker run -d -p 3310:3310 clamav/clamav:latest
```

#### AWS Infrastructure provisioning and code deployment guide

* Create an [IAM policy](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_create-console.html) with the below mentioned permissions

```
{
    "Version": "2012-10-17",
    "Id": "anti-malware-scanning-lambda-policy",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "sns:Publish"
            ],
            "Resource": [
                "arn:aws:sns:<region>:<account-id>:<sns-topic-name>",
                "arn:aws:s3:::<s3-bucket-name>/*"
            ]
        }
    ]
}
```

* Create an [IAM Lambda Execution Role](https://docs.aws.amazon.com/lambda/latest/dg/lambda-intro-execution-role.html) and attach the above created policy

* Create a lambda function with runtime of `Java 11 (Corretto)` and attach the above created IAM Role to it.
* Create a standard SNS topic and add the below mentioned statement in it's access policy

```
{
  "Effect": "Allow",
  "Principal": {
    "Service": "lambda.amazonaws.com"
  },
  "Action": "sns:Publish",
  "Resource": "arn:aws:sns:<region>:<account-id>:<sns-topic-name>",
  "Condition": {
    "StringEquals": {
      "AWS:SourceOwner": "<account-id>"
    }
  }
}
```
* [Subscribe email address(es)](https://docs.aws.amazon.com/sns/latest/dg/sns-email-notifications.html) to the above created SNS topic to which notifications would be sent in an event of malware detection

* Under the [Lambda Function Handler](https://docs.aws.amazon.com/lambda/latest/dg/java-handler.html), add the below mentioned value

```
com.behl.malware.detector.RequestExecutor::handleRequest
```
* Execute the below command at the base project directory post updating `application.properties` with the correct values

```
mvn clean install
```

* Upload the created jar `anti-malware-scanning.jar` under the `/target` directory as the lambda function code source
* To enable and view function logs, add the `AWSLambdaBasicExecutionRole` managed policy to its execution role 
* Create an [S3 Event Notification](https://docs.aws.amazon.com/AmazonS3/latest/userguide/NotificationHowTo.html) for the event of `s3:PutObject` and associate the above created lambda
