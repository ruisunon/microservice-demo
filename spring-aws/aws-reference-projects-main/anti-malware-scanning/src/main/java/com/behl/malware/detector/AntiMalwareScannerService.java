package com.behl.malware.detector;

import java.io.InputStream;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import xyz.capybara.clamav.ClamavClient;
import xyz.capybara.clamav.commands.scan.result.ScanResult;

public class AntiMalwareScannerService {

  private final static Logger logger = LoggerFactory.getLogger(AntiMalwareScannerService.class);

  private final ClamavClient clamavClient;

  public AntiMalwareScannerService(@NotNull final ClamavClient clamavClient) {
    this.clamavClient = clamavClient;
  }

  /**
   * <p>
   * Method that communicates with hosted clamAV engine to scan provided inputStream for any
   * malware/virus.
   * </p>
   * 
   * @throws MalwareDetectedException if malware/virus is detected in provided inputStream
   * @param inputStream to scan for malware/virus
   */
  public void scan(@NotNull final InputStream inputStream) {
    ScanResult scanResult;
    try {
      scanResult = clamavClient.scan(inputStream);
    } catch (final Exception exception) {
      throw new RuntimeException("Exception occurred while attempting to scan for malware.",
          exception);
    }
    if (scanResult instanceof ScanResult.VirusFound) {
      logger.info("Virus(es) detected during anti malware scanning.");
      throw new MalwareDetectedException();
    }
    logger.info("Successfully executed anti malware scanning, no virus(es) detected.");
  }

}
