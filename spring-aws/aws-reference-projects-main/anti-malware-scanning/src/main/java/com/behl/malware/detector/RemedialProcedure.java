package com.behl.malware.detector;

import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import com.amazonaws.SdkClientException;
import com.amazonaws.auth.DefaultAWSCredentialsProviderChain;
import com.amazonaws.regions.Regions;
import com.amazonaws.services.s3.event.S3EventNotification.S3EventNotificationRecord;
import com.amazonaws.services.sns.AmazonSNS;
import com.amazonaws.services.sns.AmazonSNSClientBuilder;
import com.google.gson.Gson;

public class RemedialProcedure {

  private final static Logger logger = LoggerFactory.getLogger(RemedialProcedure.class);

  private final static AmazonSNS amazonSns =
      AmazonSNSClientBuilder.standard().withCredentials(new DefaultAWSCredentialsProviderChain())
          .withRegion(Regions.AP_SOUTH_1).build();;

  /***
   * <p>
   * Method to publish event notification record corresponding to object against which malware/virus
   * is detected to configured SNS topic. The record will be sent in JSON format.
   * </p>
   * 
   * @param s3EventNotificationRecord signifying the object that failed malware scanning
   */
  public static void perform(@NotNull final S3EventNotificationRecord s3EventNotificationRecord) {
    try {
      final String message = new Gson().toJson(s3EventNotificationRecord);
      amazonSns.publish(PropertiesUtil.getSnsTopicArn(), message);
    } catch (SdkClientException exception) {
      logger.error("Exception occurred while publishing message to SNS topic", exception);
      throw new RuntimeException(exception);
    }
    logger.info(
        "Successfully published message to SNS. Remedial procedure for object {} successful",
        s3EventNotificationRecord.getS3().getObject().getKey());
  }

}
